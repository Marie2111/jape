<project>

    <taskdef name="jarbundler" 
         classname="net.sourceforge.jarbundler.JarBundler" />
    
    <target name="clean">
        <delete dir="build"/>
    </target>

    <target name="OSXcompile">
        <mkdir dir="build/classes"/>
        <mkdir dir="build/classes/OSX"/>
        <javac 
            sourcepath=""
            srcdir="src/base:src/OSX"
            destdir="build/classes/OSX"
        />
    </target>

    <target name="standardcompile">
        <mkdir dir="build/classes"/>
        <mkdir dir="build/classes/standard"/>
        <javac 
            sourcepath=""
            srcdir="src/base:src/standard"
            destdir="build/classes/standard"
        />
    </target>
    
    <target name="basejar">
        <mkdir dir="build/jar"/>
        <jar destfile="build/jar/Jape.jar" 
             basedir="extras"
             includes = "**/*.jpg **/*.gif"
             >
        </jar>
    </target>
    
    <target name="OSXjar" depends="basejar,OSXcompile">
        <mkdir dir="build/jar/OSX"/>
        <copy file="build/jar/Jape.jar" tofile="build/jar/OSX/Jape.jar"/>
        <jar destfile="build/jar/OSX/Jape.jar" 
             basedir="build/classes/OSX"
             includes = "**/*.class"
             update="yes"
             duplicate="fail"
             >
            <manifest>
                <attribute name="Main-Class" value="uk.org.jape.Jape"/>
            </manifest>
        </jar>
    </target>
    
    <target name="standardjar" depends="basejar,standardcompile">
        <mkdir dir="build/jar/standard"/>
        <copy file="build/jar/Jape.jar" tofile="build/jar/standard/Jape.jar"/>
        <jar destfile="build/jar/standard/Jape.jar" 
             basedir="build/classes/standard"
             includes = "**/*.class"
             update="yes"
             duplicate="fail"
             >
            <manifest>
                <attribute name="Main-Class" value="uk.org.jape.Jape"/>
            </manifest>
        </jar>
    </target>
    
    <!-- ../camlengine/jape_engine must be built before Jape.app -->
    
    <target name="OSXapp" depends="OSXcompile,OSXjar">
        <jarbundler dir="build"
                    name="Jape"
                    mainclass="uk.org.jape.Jape"
                    jar="build/jar/OSX/Jape.jar"
                    shortname="Jape"
                    >
            <javaproperty name="apple.laf.useScreenMenuBar" value="true"/>
            <javaproperty name="apple.awt.showGrowBox"      value="true"/>
            <javaproperty name="apple.awt.antialiasing"     value="true"/>
            <javaproperty name="apple.awt.rendering"        value="quality"/>
        </jarbundler>
            
        <delete file="build/Jape.app/Contents/MacOS/JavaApplicationStub"/>
        <exec executable="ln">
            <arg line="-s /System/Library/Frameworks/JavaVM.framework/Resources/MacOS/JavaApplicationStub"/>
            <arg value="build/Jape.app/Contents/MacOS/JavaApplicationStub"/>
        </exec>
        <mkdir dir="build/Jape.app/Contents/Engine"/>
        <copy file="../camlengine/jape_engine" tofile="build/Jape.app/Contents/Engine/jape_engine"/>
        <exec executable="chmod">
            <arg value="755"/>
            <arg value="build/Jape.app/Contents/Engine/jape_engine"/>
        </exec>
    </target>

    <target name="standardrun" depends="standardjar">
        <java jar="build/jar/standard/Jape.jar" fork="true"/>
    </target>

    <target name="OSXrun" depends="OSXapp">
        <exec executable="open">
        <arg value="build/Jape.app"/>
        </exec>
    </target>

</project>
